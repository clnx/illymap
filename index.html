<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Illymap : Illyriad Map Analytics" />
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <script src="javascripts/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script src="javascripts/gl-matrix-1.3.5-min.js" type="text/javascript"></script>
    <script src="javascripts/main.js" type="text/javascript"></script>
    <script id="shader-fs" type="x-shader/x-fragment">
      precision mediump float;

      uniform sampler2D uMapSampler;
      uniform sampler2D uStarSampler;
      uniform sampler2D uTownsSampler;

      uniform bool uGreyBg;
      uniform bool uStars;
      uniform vec3 uColor;
      uniform bool uShowTowns;

      varying vec2 vTextureCoord;

      void main(void) {
        if (uStars) {
          vec4 textureColor = texture2D(uStarSampler, vec2(vTextureCoord.s, vTextureCoord.t));
          gl_FragColor = textureColor * vec4(uColor, 1.0);
        }
        else {
          bool is_town = false;
          if (uShowTowns) {
            vec2 pos = vTextureCoord * 0.48828125; // 0.48828125 = 1000 / 1024 * 0.5; 0.00012207 = 0.48828125 / 4000
            is_town = (texture2D(uTownsSampler, vec2(pos.s, pos.t)) != vec4(0.0, 0.0, 0.0, 0.0));
            if (!is_town) is_town = (texture2D(uTownsSampler, vec2(pos.s + 0.00012207, pos.t)) != vec4(0.0, 0.0, 0.0, 0.0));
            if (!is_town) is_town = (texture2D(uTownsSampler, vec2(pos.s, pos.t + 0.00012207)) != vec4(0.0, 0.0, 0.0, 0.0));
            if (!is_town) is_town = (texture2D(uTownsSampler, vec2(pos.s + 0.00012207, pos.t + 0.00012207)) != vec4(0.0, 0.0, 0.0, 0.0));
          }
          if (is_town)
            gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);
          else {
            gl_FragColor = texture2D(uMapSampler, vec2(vTextureCoord.s, vTextureCoord.t));
            if (uGreyBg) {
              float grey = (0.34 * gl_FragColor.r + 0.5 * gl_FragColor.g + 0.16 * gl_FragColor.b);
              gl_FragColor = vec4(grey, grey, grey, gl_FragColor[3]);
            }
          }
        }
      }
    </script>

    <script id="shader-vs" type="x-shader/x-vertex">
      attribute vec3 aVertexPosition;
      attribute vec2 aTextureCoord;

      uniform mat4 uMVMatrix;
      uniform mat4 uPMatrix;

      varying vec2 vTextureCoord;

      void main(void) {
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        vTextureCoord = aTextureCoord;
      }
    </script>
    <title>Illymap</title>
  </head>

  <body>
    <header>
      <div id="header_left">
        <h1>Illymap</h1>
        <h2>Illyriad Map Analytics</h2>
      </div>
      <div id="header_right">
        <form name="ui_form">
          <div class="ui_panel">
            <div id="server_info">server:?<br/>date:?<br/></div>
            <div id="pos_info" class="tooltip" data-tooltip="Double-click on the map to open a new tab with the Illyriad map page centered on the position.">[ 0 : 0 ]</div>
          </div>
          <div class="ui_panel">
            <label id="overlay_mode_label" for="overlay_mode" class="tooltip" data-tooltip="Select the map overlay mode. Population overlays should take a few seconds on a decent computer. Race partition should be roughly 5x, in both CPU and memory. Alliance partition is the heaviest computation, and it will eat memory proportional to the maximum number of alliances that have influence over a single spot. To decrease that chance, use a smaller sigma.">Overlay:</label>
            <select id="overlay_mode">
              <option value="none" selected="selected">None</option>
              <option value="pop">Population</option>
              <option value="pop:E">Elves</option>
              <option value="pop:H">Humans</option>
              <option value="pop:D">Dwarves</option>
              <option value="pop:O">Orcs</option>
              <option value="par:races">Races (Partition)</option>
              <option value="par:alliances">Alliances (Partition)</option>
              <option value="par:confeds">Confederations (Partition)</option>
            </select><br />
            <label id="std_dev_label" for="std_dev" class="tooltip" data-tooltip="The population of each city is spread out according to a normal (Gaussian) distribution. With this option you can change its standard deviation. Higher values will give a smoother appearence to the overlays, but increase CPU time (memory unchanged). Note that the units are map-units, and the map is 1:2 vs. in-game squares.">Sigma:</label>
            <select id="std_dev">
              <option value="2">2</option>
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="15" selected="selected">15</option>
              <option value="20">20</option>
              <option value="30">30</option>
              <option value="50">50</option>
            </select>
          </div>
          <div class="ui_panel">
            <input id="show_map" type="checkbox" checked="checked" /><label for="show_map" class="tooltip" data-tooltip="Show the background map.">Show Map</label><br />
            <input id="show_towns" type="checkbox" /><label for="show_towns" class="tooltip" data-tooltip="Show towns as blue dots on the map.">Show Towns</label><br />
            <input id="show_capitals" type="checkbox" checked="checked" /><label for="show_capitals" class="tooltip" data-tooltip="Show alliance capitals as yellow stars. Mouse over them to see more information.">Show Capitals</label>
          </div>
          <div class="ui_panel"><a id="xml2json_btn" href="#" class="tooltip" data-tooltip="For hosters. This is a static app, and can work locally on a computer (copy all files). To update the dataset: After uploading newer versions of datafile_alliances.xml and datafile_towns.xml into the data folder, click this to generate the json data. After generation, copy the data from the screen and paste it into the data/data.json file.">XML2JSON</a></div>
        </form>
      </div>
    </header>

    <section id="main_content">
      <canvas id="map" width="1000" height="1000"></canvas>
      <div id="jsondiv"></div>
      <div id="infobox"></div>
    </section>

    <footer>
      <p class="copyright">Illymap maintained by <a href="https://github.com/clnx">clnx</a></p>
      <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
    </footer>
  </body>
</html>
